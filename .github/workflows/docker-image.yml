name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    env:
      PKG_NAME: my-image-artifacts
      GITEA_USER: ${{ secrets.GITEA_USERNAME }}
      GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU and Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image & prepare tarball
        run: |
          # Generate a timestamp to use as image tag and version
          TIMESTAMP=$(date +%s)
          IMAGE_TAG="my-image:${TIMESTAMP}"
          ART_NAME="${TIMESTAMP}.tar.gz"

          # Build the Docker image
          docker build . -f Dockerfile -t "${IMAGE_TAG}"

          # Save the image to a gzipped tarball
          docker save "${IMAGE_TAG}" | gzip > "${ART_NAME}"

          # Export variables for the next step
          echo "VERSION=${TIMESTAMP}" >> $GITHUB_ENV
          echo "ART_NAME=${ART_NAME}"  >> $GITHUB_ENV

      - name: Upload tarball to Gitea Generic Packages
        run: |
          curl --fail --user "${GITEA_USER}:${GITEA_TOKEN}" \
               --upload-file "${ART_NAME}" \
               "https://gitea.com/api/packages/${GITEA_USER}/generic/${PKG_NAME}/${VERSION}/${ART_NAME}"
